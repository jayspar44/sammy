#!/bin/sh
# Pre-commit hook: Security scan for secrets and sensitive files
# This runs automatically before every commit (via Husky)

echo "Running pre-commit security scan..."

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR 2>/dev/null)

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

FOUND_ISSUES=0

# Check for sensitive files (BLOCKING)
SENSITIVE_PATTERNS="\
\.env$|\
\.env\.|\
\.jks$|\
\.keystore$|\
\.p12$|\
\.pem$|\
\.key$|\
credentials\.json$|\
service-account.*\.json$|\
firebase-adminsdk.*\.json$|\
google-services\.json$|\
GoogleService-Info\.plist$|\
\.secret$|\
^secrets/|\
^private/|\
id_rsa|\
id_ed25519|\
\.pfx$"

# Exception patterns (allowed)
EXCEPTION_PATTERNS="\.example$|\.template$"

for file in $STAGED_FILES; do
  # Skip exceptions
  if echo "$file" | grep -qE "$EXCEPTION_PATTERNS"; then
    continue
  fi

  # Check for sensitive file patterns
  if echo "$file" | grep -qE "$SENSITIVE_PATTERNS"; then
    if [ $FOUND_ISSUES -eq 0 ]; then
      echo ""
      echo "BLOCKING: Sensitive files staged for commit:"
    fi
    echo "  - $file"
    FOUND_ISSUES=1
  fi
done

# Check for hardcoded secrets in staged content (BLOCKING)
SECRET_PATTERNS="\
AIza[0-9A-Za-z_-]{35}|\
sk-[0-9a-zA-Z]{48}|\
sk_live_[0-9a-zA-Z]{24,}|\
pk_live_[0-9a-zA-Z]{24,}|\
AKIA[0-9A-Z]{16}|\
ghp_[0-9a-zA-Z]{36}|\
gho_[0-9a-zA-Z]{36}|\
ghs_[0-9a-zA-Z]{36}|\
github_pat_[0-9a-zA-Z_]{22,}|\
xox[baprs]-[0-9a-zA-Z-]{10,}|\
-----BEGIN.*PRIVATE KEY-----"

for file in $STAGED_FILES; do
  # Skip binary files and images
  if echo "$file" | grep -qE "\.(png|jpg|jpeg|gif|svg|ico|webp|woff|woff2|ttf|eot)$"; then
    continue
  fi

  # Skip this hook file itself (contains regex patterns that look like secrets)
  if echo "$file" | grep -qE "^\.husky/pre-commit$"; then
    continue
  fi

  # Skip if file doesn't exist (deleted)
  if [ ! -f "$file" ]; then
    continue
  fi

  # Check staged content for secrets
  MATCHES=$(git diff --cached "$file" 2>/dev/null | grep -E "^\+" | grep -oE "$SECRET_PATTERNS" | head -3)
  if [ -n "$MATCHES" ]; then
    if [ $FOUND_ISSUES -eq 0 ]; then
      echo ""
      echo "BLOCKING: Hardcoded secrets found:"
    fi
    echo "  - $file"
    echo "    Patterns: $(echo "$MATCHES" | head -1 | cut -c1-40)..."
    FOUND_ISSUES=1
  fi
done

if [ $FOUND_ISSUES -eq 1 ]; then
  echo ""
  echo "Commit BLOCKED. Remove secrets before committing."
  echo ""
  echo "To unstage files: git reset HEAD <file>"
  echo "To bypass (DANGEROUS): git commit --no-verify"
  echo ""
  exit 1
fi

echo "Security scan passed."
exit 0
