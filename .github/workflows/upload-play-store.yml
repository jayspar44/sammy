# GitHub Actions workflow for uploading to Play Store
#
# Triggered: Manual (workflow_dispatch)
#
# Features:
# - Build signed AAB (Android App Bundle) for prod or dev flavor
# - Upload to Play Store Internal/Alpha/Beta track
# - Supports both io.sammy.app (prod) and io.sammy.app.dev (dev)
# - Auto-increments versionCode using GitHub run number
#
# Prerequisites:
# 1. Play Console account verified
# 2. App created in Play Console
# 3. Service account with API access
# 4. GitHub secrets configured
#
# Required Secrets:
# - KEYSTORE_BASE64: Base64 encoded release keystore
# - KEYSTORE_PASSWORD: Keystore password
# - KEY_ALIAS: Key alias
# - KEY_PASSWORD: Key password
# - FIREBASE_CLIENT_CONFIG: Firebase client config JSON
# - PLAY_SERVICE_ACCOUNT_JSON: Play Store service account JSON

name: Upload to Play Store

on:
  workflow_dispatch:
    inputs:
      flavor:
        description: 'App flavor (prod = io.sammy.app, dev = io.sammy.app.dev)'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
          - dev
      track:
        description: 'Release track'
        required: true
        default: 'internal'
        type: choice
        options:
          - internal
          - alpha
          - beta
      release_notes:
        description: 'Release notes (optional)'
        required: false
        default: 'Bug fixes and improvements'
      status:
        description: 'Release status (draft for new apps, completed to roll out)'
        required: true
        default: 'draft'
        type: choice
        options:
          - draft
          - completed

env:
  NODE_VERSION: '22'
  JAVA_VERSION: '21'

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Get version from package.json
        id: version
        working-directory: frontend
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Create environment file
        working-directory: frontend
        run: |
          if [ "${{ inputs.flavor }}" = "prod" ]; then
            API_URL="https://sammy-backend-prod-u7dzitmnha-uc.a.run.app/api"
          else
            API_URL="https://sammy-backend-dev-u7dzitmnha-uc.a.run.app/api"
          fi
          echo "VITE_API_URL=$API_URL" > .env.production
          echo "VITE_FIREBASE_CONFIG=${{ secrets.FIREBASE_CLIENT_CONFIG }}" >> .env.production
          echo "Building ${{ inputs.flavor }} flavor with API: $API_URL"

      - name: Build web assets
        working-directory: frontend
        run: npm run build -- --mode production

      - name: Update Capacitor config for production
        working-directory: frontend
        run: |
          cat > capacitor.config.json << EOF
          {
            "appId": "io.sammy.app",
            "appName": "Sammy",
            "webDir": "dist",
            "server": {
              "androidScheme": "https"
            },
            "plugins": {
              "Keyboard": {
                "resize": "native",
                "style": "dark",
                "resizeOnFullScreen": true
              },
              "StatusBar": {
                "overlay": true
              },
              "SystemBars": {
                "insetsHandling": "disable"
              }
            }
          }
          EOF

      - name: Add and sync Capacitor Android
        working-directory: frontend
        run: |
          npx cap add android
          npx cap sync android

      - name: Configure release signing and versioning
        working-directory: frontend/android/app
        run: |
          # Decode keystore
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > release.keystore
          ls -la release.keystore

          # Update versionCode (use run number to auto-increment)
          sed -i "s/versionCode 1/versionCode ${{ github.run_number }}/" build.gradle

          # Update versionName to match package.json
          sed -i 's/versionName "1.0"/versionName "${{ steps.version.outputs.version }}"/' build.gradle

          echo "Set versionCode=${{ github.run_number }}, versionName=${{ steps.version.outputs.version }}"

          # Add product flavors for prod and dev builds
          sed -i '/buildTypes {/i\
              flavorDimensions = ["environment"]\
              productFlavors {\
                  dev {\
                      dimension "environment"\
                      applicationIdSuffix ".dev"\
                      resValue "string", "app_name", "Sammy (Dev)"\
                  }\
                  prod {\
                      dimension "environment"\
                      resValue "string", "app_name", "Sammy"\
                  }\
              }' build.gradle

          # Add signing config to build.gradle
          sed -i '/buildTypes {/i\
              signingConfigs {\
                  release {\
                      storeFile file("release.keystore")\
                      storePassword System.getenv("KEYSTORE_PASSWORD")\
                      keyAlias System.getenv("KEY_ALIAS")\
                      keyPassword System.getenv("KEY_PASSWORD")\
                  }\
              }' build.gradle

          # Update release buildType to use signing config
          sed -i '/release {/,/}/ s/minifyEnabled false/signingConfig signingConfigs.release\n            minifyEnabled false/' build.gradle

          echo "Updated build.gradle with signing config and product flavors"

      - name: Build Release AAB
        working-directory: frontend/android
        run: |
          chmod +x ./gradlew
          FLAVOR="${{ inputs.flavor }}"
          # Capitalize first letter for gradle task
          FLAVOR_CAP="$(echo ${FLAVOR:0:1} | tr '[:lower:]' '[:upper:]')${FLAVOR:1}"
          echo "Building bundle${FLAVOR_CAP}Release..."
          ./gradlew bundle${FLAVOR_CAP}Release
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Upload AAB as artifact
        uses: actions/upload-artifact@v4
        with:
          name: sammy-${{ inputs.flavor }}-release-${{ steps.version.outputs.version }}-${{ github.run_number }}
          path: frontend/android/app/build/outputs/bundle/${{ inputs.flavor }}Release/app-${{ inputs.flavor }}-release.aab
          retention-days: 90

      - name: Upload to Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: ${{ inputs.flavor == 'prod' && 'io.sammy.app' || 'io.sammy.app.dev' }}
          releaseFiles: frontend/android/app/build/outputs/bundle/${{ inputs.flavor }}Release/app-${{ inputs.flavor }}-release.aab
          track: ${{ inputs.track }}
          status: ${{ inputs.status }}
          releaseName: v${{ steps.version.outputs.version }}${{ inputs.flavor == 'dev' && '-dev' || '' }}
          whatsNewDirectory: ''
          inAppUpdatePriority: 0

      - name: Build Summary
        run: |
          if [ "${{ inputs.flavor }}" = "prod" ]; then
            PACKAGE_NAME="io.sammy.app"
          else
            PACKAGE_NAME="io.sammy.app.dev"
          fi
          echo "## Play Store Upload Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Flavor** | ${{ inputs.flavor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | v${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version Code** | ${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Track** | ${{ inputs.track }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | ${{ inputs.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Package** | $PACKAGE_NAME |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the [Play Console](https://play.google.com/console) for release status." >> $GITHUB_STEP_SUMMARY
