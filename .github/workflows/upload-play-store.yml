# GitHub Actions workflow for uploading to Play Store
#
# Triggered: Manual (workflow_dispatch)
#
# Features:
# - Build signed AAB (Android App Bundle) for prod or dev flavor
# - Upload to Play Store Internal/Alpha/Beta track
# - Supports both io.sammy.app (prod) and io.sammy.app.dev (dev)
# - Auto-increments versionCode using GitHub run number
#
# Prerequisites:
# 1. Play Console account verified
# 2. App created in Play Console
# 3. Service account with API access
# 4. GitHub secrets configured
#
# Required Secrets:
# - KEYSTORE_BASE64: Base64 encoded release keystore
# - KEYSTORE_PASSWORD: Keystore password
# - KEY_ALIAS: Key alias
# - KEY_PASSWORD: Key password
# - FIREBASE_CLIENT_CONFIG: Firebase client config JSON
# - PLAY_SERVICE_ACCOUNT_JSON: Play Store service account JSON

name: Upload to Play Store

on:
  workflow_dispatch:
    inputs:
      flavor:
        description: 'App flavor (prod = io.sammy.app, dev = io.sammy.app.dev)'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
          - dev
      track:
        description: 'Release track'
        required: true
        default: 'internal'
        type: choice
        options:
          - internal
          - alpha
          - beta
      release_notes:
        description: 'Release notes (optional)'
        required: false
        default: 'Bug fixes and improvements'
      status:
        description: 'Release status (draft for new apps, completed to roll out)'
        required: true
        default: 'draft'
        type: choice
        options:
          - draft
          - completed

env:
  NODE_VERSION: '22'
  JAVA_VERSION: '21'

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Get version from package.json
        id: version
        working-directory: frontend
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Create environment file
        working-directory: frontend
        env:
          FIREBASE_CONFIG: ${{ secrets.FIREBASE_CLIENT_CONFIG }}
        run: |
          # Determine build mode and API URL based on flavor
          if [ "${{ inputs.flavor }}" = "prod" ]; then
            BUILD_MODE="production"
            API_URL="https://sammy-backend-prod-u7dzitmnha-uc.a.run.app/api"
          else
            BUILD_MODE="dev"
            API_URL="https://sammy-backend-dev-u7dzitmnha-uc.a.run.app/api"
          fi

          echo "Creating .env.$BUILD_MODE with API URL: $API_URL"
          echo "VITE_API_URL=$API_URL" > .env.$BUILD_MODE

          # Write Firebase config via environment variable (safest method)
          echo "VITE_FIREBASE_CONFIG=$FIREBASE_CONFIG" >> .env.$BUILD_MODE

          # Verify env file was created
          echo "Environment file created: .env.$BUILD_MODE"
          echo "File size: $(wc -c < .env.$BUILD_MODE) bytes"
          echo "Line count: $(wc -l < .env.$BUILD_MODE) lines"

      - name: Build web assets
        working-directory: frontend
        run: |
          if [ "${{ inputs.flavor }}" = "prod" ]; then
            npm run build -- --mode production
          else
            npm run build -- --mode dev
          fi

      - name: Verify build output
        working-directory: frontend
        run: |
          echo "Checking dist/ directory..."
          ls -lah dist/

          # Verify index.html exists
          if [ ! -f "dist/index.html" ]; then
            echo "ERROR: dist/index.html not found!"
            exit 1
          fi

          # Check if Firebase config is in the bundle (search for projectId)
          if grep -r "sammy-658" dist/assets/*.js > /dev/null 2>&1; then
            echo "✓ Firebase config found in build"
          else
            echo "⚠ WARNING: Firebase config may not be embedded in build"
          fi

          echo "Build verification complete"

      - name: Update Capacitor config
        working-directory: frontend
        run: |
          # Determine app configuration based on flavor
          if [ "${{ inputs.flavor }}" = "prod" ]; then
            APP_ID="io.sammy.app"
            APP_NAME="Sammy"
          else
            APP_ID="io.sammy.app.dev"
            APP_NAME="Sammy (Dev)"
          fi

          # Create capacitor config
          cat > capacitor.config.json << EOF
          {
            "appId": "$APP_ID",
            "appName": "$APP_NAME",
            "webDir": "dist",
            "server": {
              "androidScheme": "https"
            },
            "plugins": {
              "Keyboard": {
                "resize": "native",
                "style": "dark",
                "resizeOnFullScreen": true
              },
              "StatusBar": {
                "overlay": true
              },
              "SystemBars": {
                "insetsHandling": "disable"
              }
            }
          }
          EOF

          cat capacitor.config.json

      - name: Add Capacitor Android platform
        working-directory: frontend
        run: |
          # Remove any existing android directory to avoid prompts
          rm -rf android
          npx cap add android

      - name: Generate custom Android assets
        working-directory: frontend
        run: |
          echo "Generating custom icons and splash screens..."
          npm run generate:android-assets
          echo "✓ Custom Android assets generated"

      - name: Sync Capacitor
        working-directory: frontend
        run: |
          npx cap sync android
          echo "✓ Capacitor sync complete"

      - name: Configure release signing and versioning
        working-directory: frontend/android
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          # Decode keystore to app directory
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/release.keystore
          ls -la app/release.keystore

          # Update versionCode (run_number * 100 - allows ~100 manual uploads between CI runs)
          VERSION_CODE=$(( ${{ github.run_number }} * 100 ))
          sed -i "s/versionCode 1/versionCode $VERSION_CODE/" app/build.gradle

          # Update versionName to match package.json
          sed -i 's/versionName "1.0"/versionName "${{ steps.version.outputs.version }}"/' app/build.gradle

          echo "Set versionCode=$VERSION_CODE (run #${{ github.run_number }} x 100), versionName=${{ steps.version.outputs.version }}"

          # Write signing credentials to gradle.properties (more reliable for special chars)
          echo "" >> gradle.properties
          echo "# Signing credentials (added by CI)" >> gradle.properties
          echo "KEYSTORE_PASSWORD=$KEYSTORE_PASSWORD" >> gradle.properties
          echo "KEY_ALIAS=$KEY_ALIAS" >> gradle.properties
          echo "KEY_PASSWORD=$KEY_PASSWORD" >> gradle.properties
          echo "✓ Signing credentials written to gradle.properties"

          # Add signing config to build.gradle that reads from project properties
          sed -i '/buildTypes {/i\
              signingConfigs {\
                  release {\
                      storeFile file("release.keystore")\
                      storePassword project.hasProperty("KEYSTORE_PASSWORD") ? project.KEYSTORE_PASSWORD : ""\
                      keyAlias project.hasProperty("KEY_ALIAS") ? project.KEY_ALIAS : ""\
                      keyPassword project.hasProperty("KEY_PASSWORD") ? project.KEY_PASSWORD : ""\
                  }\
              }' app/build.gradle

          # Update release buildType to use signing config
          sed -i '/release {/,/}/ s/minifyEnabled false/signingConfig signingConfigs.release\n            minifyEnabled false/' app/build.gradle

          echo "✓ Updated build.gradle with signing config"

      - name: Build Release AAB
        working-directory: frontend/android
        run: |
          chmod +x ./gradlew
          echo "Building bundleRelease for ${{ inputs.flavor }} (appId set via Capacitor config)..."
          ./gradlew bundleRelease

      - name: Upload AAB as artifact
        uses: actions/upload-artifact@v4
        with:
          name: sammy-${{ inputs.flavor }}-release-${{ steps.version.outputs.version }}-${{ github.run_number }}
          path: frontend/android/app/build/outputs/bundle/release/app-release.aab
          retention-days: 90

      - name: Upload to Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: ${{ inputs.flavor == 'prod' && 'io.sammy.app' || 'io.sammy.app.dev' }}
          releaseFiles: frontend/android/app/build/outputs/bundle/release/app-release.aab
          track: ${{ inputs.track }}
          status: ${{ inputs.status }}
          releaseName: v${{ steps.version.outputs.version }}${{ inputs.flavor == 'dev' && '-dev' || '' }}
          whatsNewDirectory: ''
          inAppUpdatePriority: 0

      - name: Build Summary
        run: |
          if [ "${{ inputs.flavor }}" = "prod" ]; then
            PACKAGE_NAME="io.sammy.app"
          else
            PACKAGE_NAME="io.sammy.app.dev"
          fi
          echo "## Play Store Upload Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Flavor** | ${{ inputs.flavor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | v${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version Code** | ${{ github.run_number }} x 100 = $(( ${{ github.run_number }} * 100 )) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Track** | ${{ inputs.track }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | ${{ inputs.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Package** | $PACKAGE_NAME |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the [Play Console](https://play.google.com/console) for release status." >> $GITHUB_STEP_SUMMARY
