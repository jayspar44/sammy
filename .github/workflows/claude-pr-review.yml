name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  automatic-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Review this pull request and post your findings as a PR comment using `gh pr comment`.

            First, use `gh pr view` and `gh pr diff` to understand the changes.

            REVIEW CRITERIA:
            - Security: exposed secrets, auth issues, input validation
            - Correctness: logic errors, edge cases, error handling
            - Performance: N+1 queries, memory leaks, inefficient code
            - Maintainability: readability, naming, DRY violations

            SEVERITY DEFINITIONS:
            - ðŸ”´ BLOCKING: Must fix before merge (security, correctness, broken functionality)
            - ðŸŸ¡ WARNING: Should fix (performance, error handling, maintainability)
            - ðŸŸ¢ NIT: Optional minor improvements (style, naming, small refactors)
            - ðŸ”µ FUTURE: Potential future enhancement (architectural improvements that don't impact current build but would benefit long-term)

            REQUIRED OUTPUT FORMAT (post this as a PR comment using `gh pr comment`):

            ## Code Review

            **Verdict**: [APPROVE if 0 blocking, REQUEST CHANGES if any blocking]

            ### Summary

            | # | Issue | Suggested Fix | Severity |
            |---|-------|---------------|----------|
            | 1 | [Brief issue description] | [Brief fix] | ðŸ”´ Blocking |
            | 2 | [Brief issue description] | [Brief fix] | ðŸŸ¡ Warning |
            | 3 | [Brief issue description] | [Brief fix] | ðŸŸ¢ Nit |
            | 4 | [Brief issue description] | [Brief fix] | ðŸ”µ Future |

            [If no issues, show: "No issues found âœ…"]

            ---

            ### ðŸ”´ Blocking Issues
            [List each, or "None"]

            1. **[SHORT TITLE]** (matches Summary row #)
               - File: `path/file.js:LINE`
               - Issue: [What's wrong]
               - Why blocking: [Risk if not fixed]
               - Fix: [How to fix]

            ### ðŸŸ¡ Warnings
            [List each, or "None"]

            1. **[SHORT TITLE]** (matches Summary row #)
               - File: `path/file.js:LINE`
               - Issue: [What's wrong]
               - Suggestion: [How to improve]

            ### ðŸŸ¢ Nits
            [List each, or "None"]

            1. `path/file.js:LINE` - [Brief suggestion] (matches Summary row #)

            ### ðŸ”µ Future Enhancements
            [List each, or "None"]

            1. **[SHORT TITLE]** (matches Summary row #)
               - Current: [What the code does now]
               - Better long-term: [What would be better architecturally]
               - Why not blocking: [Confirms current implementation works fine]

            ### âœ… What's Good
            - [Positive aspects of this PR]

            IMPORTANT:
            - Use `gh pr comment` with your Bash tool to post the review
            - Summary table MUST list ALL issues with matching row numbers
            - Each detailed section item MUST correspond to a Summary row
            - Row numbers in Summary must match the item numbers in detailed sections
            - Verdict MUST be REQUEST CHANGES if any blocking issues exist
          claude_args: '--max-turns 10 --allowed-tools "Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Read,Glob,Grep"'

  interactive-review:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: '--allowed-tools "Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(gh issue view:*),Bash(gh issue list:*),Read,Glob,Grep"'
