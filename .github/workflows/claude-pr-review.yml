name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  automatic-review:
    # Disabled - using manual /code-review skill instead (API key switched to subscription)
    if: false && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Review this PR thoroughly. Use `gh pr diff` to see changes and `gh pr view` for context.

            ## REVIEW CHECKLIST

            ### 1. Project Standards (CLAUDE.md)
            - **Backend logging**: Must use `req.log` (Pino), NOT `console.log`
            - **Frontend API calls**: Must use `api/` directory wrappers, NOT raw fetch in components
            - **Naming**: Files kebab-case, React components PascalCase, variables camelCase
            - **Backend structure**: Controller-Service pattern (routes ‚Üí controllers ‚Üí services)
            - **Frontend state**: React Context for global state only, local state for components
            - **Mobile**: Browser-only APIs must have Capacitor compatibility checks

            ### 2. Security (CRITICAL)
            - All API endpoints (except /api/health) must verify Firebase Auth token
            - No hardcoded secrets, API keys, or credentials
            - Input validation on all user inputs (check for injection, XSS)
            - Firestore security rules must match endpoint permissions
            - No sensitive data in logs or error messages

            ### 3. Cost/Rate Control
            - AI endpoints (Gemini) must have rate limiting
            - Firestore queries must be bounded (use limits, pagination)
            - No unbounded loops or recursive calls to external APIs

            ### 4. Logic & Correctness
            - Error handling: catch blocks must handle errors appropriately
            - Async/await: proper error propagation
            - Edge cases: null checks, empty arrays, missing fields

            ## SEVERITY LEVELS

            üî¥ **BLOCKING** - PR cannot merge until fixed:
            - Security vulnerabilities
            - Broken functionality
            - Data loss risk
            - Missing auth checks

            üü° **HIGH** - Should fix before merge:
            - Project standard violations (CLAUDE.md)
            - Missing error handling
            - Performance issues
            - Missing input validation

            üü¢ **MEDIUM** - Fix in follow-up PR acceptable:
            - Code clarity improvements
            - Minor refactoring opportunities
            - Missing edge case handling

            ‚ÑπÔ∏è **INFO** - Optional improvements:
            - Style suggestions
            - Alternative approaches
            - Future enhancement ideas

            ## OUTPUT FORMAT

            ```
            ## Code Review: [PR Title]

            **Verdict**: ‚úÖ APPROVE | ‚ö†Ô∏è APPROVE WITH NOTES | ‚ùå REQUEST CHANGES

            ### Summary
            [2-3 sentence overview of changes and overall quality]

            | # | Issue | File | Severity |
            |---|-------|------|----------|
            | 1 | Brief description | `file:line` | üî¥/üü°/üü¢/‚ÑπÔ∏è |

            ---

            ### üî¥ Blocking Issues
            (Skip section if none)

            **1. [Issue Title]**
            - **Location**: `file/path.js:123`
            - **Problem**: What's wrong and why it matters
            - **Fix**:
            ```js
            // Current (wrong)
            console.log('error', err);

            // Required
            req.log.error({ err }, 'Error message');
            ```

            ---

            ### üü° High Priority
            (Skip section if none)

            **1. [Issue Title]** - `file:line`
            Problem and suggested fix.

            ---

            ### üü¢ Medium Priority
            (Skip section if none)

            1. `file:line` - Brief suggestion

            ---

            ### ‚ÑπÔ∏è Info
            (Skip section if none)

            1. Consider [improvement] for [reason]

            ---

            ### ‚úÖ What's Good
            - Positive aspect 1
            - Positive aspect 2
            ```

            ## RULES
            1. Summary table and detail sections must be in the same order
            2. Include code examples for all blocking issues
            3. Reference specific CLAUDE.md sections when citing violations
            4. Be constructive - explain WHY something is a problem
            5. Acknowledge good patterns and improvements

            Post your review using `gh pr comment`.
          claude_args: '--allowed-tools "Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Read,Glob,Grep"'

  interactive-review:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You were mentioned in a PR comment. Read the comment and respond helpfully.

            Use `gh pr view` to see the PR, `gh pr diff` to see changes, and read any relevant files.

            ## WHEN ASKED TO REVIEW (or re-review)

            Apply the same standards as automatic reviews:

            ### Project Standards (CLAUDE.md)
            - **Backend logging**: Must use `req.log` (Pino), NOT `console.log`
            - **Frontend API calls**: Must use `api/` directory wrappers, NOT raw fetch in components
            - **Naming**: Files kebab-case, React components PascalCase, variables camelCase
            - **Backend structure**: Controller-Service pattern (routes ‚Üí controllers ‚Üí services)
            - **Frontend state**: React Context for global state only, local state for components
            - **Mobile**: Browser-only APIs must have Capacitor compatibility checks

            ### Security (CRITICAL)
            - All API endpoints (except /api/health) must verify Firebase Auth token
            - No hardcoded secrets, API keys, or credentials
            - Input validation on all user inputs (check for injection, XSS)
            - No sensitive data in logs or error messages

            ### Cost/Rate Control
            - AI endpoints (Gemini) must have rate limiting
            - Firestore queries must be bounded (use limits, pagination)

            ### Severity Levels
            - üî¥ **BLOCKING**: Security, broken functionality, missing auth
            - üü° **HIGH**: Standard violations, missing error handling
            - üü¢ **MEDIUM**: Code clarity, minor refactoring
            - ‚ÑπÔ∏è **INFO**: Optional improvements

            ## WHEN ASKED SPECIFIC QUESTIONS

            Answer directly and concisely. Reference specific files and line numbers.
            If asked about code, read the relevant files first.

            ## WHEN ASKED TO EXPLAIN OR HELP

            Be helpful and educational. Explain the "why" not just the "what".
            Reference CLAUDE.md conventions when relevant.

            Post your response using `gh pr comment`.
          claude_args: '--allowed-tools "Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(gh issue view:*),Bash(gh issue list:*),Read,Glob,Grep"'
